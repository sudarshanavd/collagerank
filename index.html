<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>College Rank Slideshow (Live)</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 20px;
      background: radial-gradient(circle at top left, #e0ecff, #f5f7fb);
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    h1 {
      margin: 10px 0 4px;
      color: #1a1a1a;
      text-align: center;
    }

    #updated {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 20px;
      font-weight: 500;
      text-align: center;
    }

    #loading {
      color: #0066cc;
      font-style: italic;
      text-align: center;
      margin-top: 40px;
    }

    .error {
      color: #d32f2f;
      font-weight: bold;
      text-align: center;
    }

    /* Slideshow layout */

    .slideshow-container {
      position: relative;
      max-width: 900px;
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .slide-card {
      width: 100%;
      max-width: 800px;
      background: white;
      box-shadow: 0 16px 40px rgba(0,0,0,0.12);
      border-radius: 18px;
      padding: 26px 28px 22px;
      box-sizing: border-box;
      display: none; /* shown via JS */
      transform-origin: center;
      transition: transform 0.4s ease, box-shadow 0.4s ease, opacity 0.4s ease;
      opacity: 0;
    }

    .slide-card.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    .slide-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 16px;
    }

    .rank-pill {
      font-size: 2.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, #ffcc33, #ff9d00);
      -webkit-background-clip: text;
      color: transparent;
      text-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }

    .rank-label {
      font-size: 0.75rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #888;
      font-weight: 600;
    }

    .college-name {
      font-size: 1.6rem;
      font-weight: 700;
      color: #222;
      margin-bottom: 4px;
    }

    .location-line {
      font-size: 0.95rem;
      color: #666;
    }

    .tag-row {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tag-pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      background: #eef2ff;
      color: #3949ab;
      border: 1px solid #d0d7ff;
    }

    .score-box {
      margin-top: 18px;
      padding: 12px 16px;
      border-radius: 12px;
      background: #f5fbff;
      border: 1px solid #cfe8ff;
      display: inline-flex;
      align-items: baseline;
      gap: 8px;
    }

    .score-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #4a6fa5;
      font-weight: 600;
    }

    .score-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: #174ea6;
    }

    /* Controls */

    .controls {
      margin-top: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 18px;
      flex-wrap: wrap;
    }

    .btn {
      border: none;
      outline: none;
      padding: 8px 18px;
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 14px rgba(0,0,0,0.18);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(0,0,0,0.18);
    }

    .btn-primary {
      background: linear-gradient(135deg, #2962ff, #3d5afe);
      color: #fff;
    }

    .btn-icon {
      font-size: 1rem;
    }

    .dots {
      display: flex;
      gap: 8px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #bbb;
      transition: all 0.3s;
    }

    .dot.active {
      width: 12px;
      height: 12px;
      background: #2962ff;
    }

    .slide-count {
      font-size: 0.8rem;
      color: #555;
      font-weight: 500;
    }

    @media (max-width: 600px) {
      .slide-card {
        padding: 18px 16px 16px;
      }
      .rank-pill {
        font-size: 2.2rem;
      }
      .college-name {
        font-size: 1.3rem;
      }
    }
    @media (max-width: 600px) {
      .slideshow-container {
        width: 90%;
        height: 160px;
      }
      .rank-pill { font-size: 2.5rem; }
      .college-name { font-size: 1.1rem; }
    }
  </style>
</head>
<body>

  <h1>College Rank List – Slide View</h1>
  <div id="updated">Loading live data...</div>

  <div class="slideshow-container">
    <div id="loading">Fetching latest rankings...</div>

    <!-- Slide cards will be injected here -->
    <div id="slides-wrapper"></div>
  </div>

  <div class="controls" id="controls" style="display:none;">
    <button class="btn" id="prev-btn">
      <span class="btn-icon">⟵</span> Prev
    </button>
    <div class="dots" id="dots"></div>
    <button class="btn btn-primary" id="next-btn">
      Next <span class="btn-icon">⟶</span>
    </button>
    <div class="slide-count" id="slide-count"></div>
  </div>

<script>
  // PASTE YOUR PUBLISHED GOOGLE SHEET CSV URL HERE (must end with output=csv)
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vScqD__mUDS5xvRn7bj7njLOUcqYKEo3MHLjOSsOIv0wTh2GFvTXOcLl_34w6PirksSafr2u5Unj1IF/pub?gid=0&single=true&output=csv";

  let colleges = [];
  let currentSlide = 0;

  // Sample fallback data for testing (remove after fixing URL)
  const SAMPLE_DATA = [
    { name: "Harvard University", location: "Cambridge, MA", score: 98.5 },
    { name: "Stanford University", location: "Stanford, CA", score: 97.2 },
    { name: "MIT", location: "Cambridge, MA", score: 96.8 },
    { name: "Yale University", location: "New Haven, CT", score: 95.1 },
    { name: "Princeton University", location: "Princeton, NJ", score: 94.3 }
  ];

  async function fetchData() {
    const loadingEl = document.getElementById("loading");
    const updatedEl = document.getElementById("updated");
    loadingEl.textContent = "Fetching latest rankings...";
    loadingEl.style.display = "block";
    loadingEl.className = ""; // Reset error class

    try {
      console.log("Fetching from:", SHEET_CSV_URL);
      const response = await fetch(SHEET_CSV_URL + "&t=" + Date.now(), { 
        method: 'GET',
        mode: 'cors', // Explicit CORS mode
        cache: 'no-cache'
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const text = await response.text();
      console.log("Raw CSV (first 200 chars):", text.substring(0, 200));

      if (!text || text.trim().length === 0) {
        throw new Error("Empty response from sheet");
      }

      // Improved CSV parsing (handles quoted fields better)
      const rows = parseCSV(text);
      console.log("Parsed rows:", rows.length);

      if (rows.length < 2) {
        throw new Error("No data rows found (need at least headers + 1 row)");
      }

      const headers = rows[0];
      console.log("Headers found:", headers);

      // Flexible column detection
      const nameCol = headers.findIndex(h => 
        h.toLowerCase().includes('college') || h.toLowerCase().includes('school') || h.toLowerCase().includes('name')
      );
      const scoreCol = headers.findIndex(h => h.toLowerCase().includes('score'));
      const locationCol = headers.findIndex(h => 
        h.toLowerCase().includes('location') || h.toLowerCase().includes('city') || h.toLowerCase().includes('state')
      );

      console.log("Column indices - Name:", nameCol, "Score:", scoreCol, "Location:", locationCol);

      if (nameCol === -1 || scoreCol === -1) {
        throw new Error(`Missing required columns. Found headers: ${headers.join(', ')}. Need 'college_name' or 'score'.`);
      }

      const map = new Map();

      // Group by college name and sum scores
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (row.length === 0 || !row[nameCol]) continue;
        
        const name = row[nameCol].trim();
        const rawScore = row[scoreCol] ? row[scoreCol].trim() : "0";
        const score = parseFloat(rawScore) || 0;
        const location = locationCol !== -1 ? (row[locationCol] || "N/A").trim() : "Location not available";

        if (!name) continue;

        if (map.has(name)) {
          const existing = map.get(name);
          existing.score += score;
        } else {
          map.set(name, { name, location, score });
        }
      }

      if (map.size === 0) {
        throw new Error("No valid colleges found in data");
      }

      // Convert to array, sort by score descending, rank
      colleges = Array.from(map.values())
        .sort((a, b) => b.score - a.score)
        .map((college, index) => ({ ...college, rank: index + 1 }))
        .slice(0, 20); // Limit to top 20 for performance

      console.log("Processed colleges:", colleges);

      renderSlides();
      updatedEl.textContent = `Last updated: ${new Date().toLocaleString()} (${colleges.length} colleges ranked)`;
      loadingEl.style.display = "none";
      document.getElementById("controls").style.display = "flex";
      showSlide(currentSlide);

    } catch (err) {
      console.error("Fetch error:", err);
      loadingEl.textContent = `Error: ${err.message}. Check console for details. Using sample data for demo.`;
      loadingEl.className = "error";
      
      // Fallback to sample data for testing
      colleges = SAMPLE_DATA.map((college, index) => ({ ...college, rank: index + 1 }));
      renderSlides();
      document.getElementById("controls").style.display = "flex";
      showSlide(currentSlide);
      updatedEl.textContent = "Using demo data (fix URL to load real rankings)";
    }
  }

  // Improved CSV parser (handles basic quoting)
  function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(line => line.trim());
    const rows = [];
    for (let line of lines) {
      const row = [];
      let field = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          row.push(field.trim());
          field = '';
        } else {
          field += char;
        }
      }
      row.push(field.trim()); // Last field
      rows.push(row);
    }
    return rows;
  }

  function renderSlides() {
    const wrapper = document.getElementById("slides-wrapper");
    wrapper.innerHTML = "";

    colleges.forEach((college) => {
      const slide = document.createElement("div");
      slide.className = "slide-card";
      slide.innerHTML = `
        <div class="slide-header">
          <div class="rank-pill">#${college.rank}</div>
        </div>
        <div class="college-name">${college.name}</div>
        <div class="location-line">${college.location}</div>
        <div class="score-box">
          <span class="score-label">Score</span>
          <span class="score-value">${college.score.toFixed(1)}</span>
        </div>
      `;
      wrapper.appendChild(slide);
    });

    // Create dots
    const dotsContainer = document.getElementById("dots");
    dotsContainer.innerHTML = "";
    colleges.forEach((_, i) => {
      const dot = document.createElement("div");
      dot.className = "dot" + (i === 0 ? " active" : "");
      dot.onclick = () => showSlide(i);
      dotsContainer.appendChild(dot);
    });

    // Update slide count if you added it
    const slideCountEl = document.getElementById("slide-count");
    if (slideCountEl) slideCountEl.textContent = `${currentSlide + 1} / ${colleges.length}`;
  }

  function showSlide(n) {
    const slides = document.querySelectorAll(".slide-card");
    const dots = document.querySelectorAll(".dot");

    currentSlide = (n + colleges.length) % colleges.length; // Loop safely

    slides.forEach((s, i) => s.classList.toggle("active", i === currentSlide));
    dots.forEach((d, i) => d.classList.toggle("active", i === currentSlide));

    const slideCountEl = document.getElementById("slide-count");
    if (slideCountEl) slideCountEl.textContent = `${currentSlide + 1} / ${colleges.length}`;
  }

  // Navigation
  document.getElementById("next-btn").onclick = () => showSlide(currentSlide + 1);
  document.getElementById("prev-btn").onclick = () => showSlide(currentSlide - 1);

  // Auto-advance slides every 4 seconds
  setInterval(() => showSlide(currentSlide + 1), 4000);

  // Refresh data every 30 seconds
  setInterval(fetchData, 30000);

  // Initial load
  fetchData();
</script>

</body>
</html>
